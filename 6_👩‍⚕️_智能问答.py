import json
import streamlit as st
from openai import OpenAI
from typing import Iterator, List, Dict
import random
import datetime

# é…ç½®ä¿¡æ¯
model_name = "åŒ»æ˜“é€šæ™ºèƒ½é—®ç­”"
model_version = "ä¸“ä¸šå¢å¼ºç‰ˆ"

client = OpenAI(api_key="sk-CXx3Cs76mQCYLhq8nrTdGb1qGijoQPXAjS8khPm29k8GU5Yt", 
               base_url="https://api.moonshot.cn/v1")
st.set_page_config(page_title=model_name, page_icon="ğŸŒ¿", layout="wide")
st.title(f"{model_name} {model_version}")

# ä¸­åŒ»æœ¯è¯­æ•°æ®åº“æ‰©å±•
TCM_TERMS_DATABASE = {
    "é˜´è™šç«æ—º": {
        "category": "é˜´é˜³å¤±è¡¡",
        "symptoms": ["äº”å¿ƒçƒ¦çƒ­", "æ½®çƒ­ç›—æ±—", "å£å¹²å’½ç‡¥", "å¤±çœ å¤šæ¢¦", "èˆŒçº¢å°‘è‹”", "å¤§ä¾¿å¹²ç»“"],
        "related": ["é˜´è™š", "ç«æ—º", "é˜´é˜³å¤±è°ƒ", "è‚è‚¾é˜´è™š"],
        "classics": "ã€Šé»„å¸å†…ç»Â·ç´ é—®ã€‹'é˜´è™šåˆ™å†…çƒ­'",
        "formulas": ["å…­å‘³åœ°é»„ä¸¸", "çŸ¥æŸåœ°é»„ä¸¸", "å¤©ç‹è¡¥å¿ƒä¸¹"],
        "acupoints": ["å¤ªæºªç©´", "ä¸‰é˜´äº¤", "æ¶Œæ³‰ç©´"]
    },
    "è‚æ°”éƒç»“": {
        "category": "è„è…‘å¤±è°ƒ",
        "symptoms": ["èƒè‚‹èƒ€ç—›", "èƒ¸é—·å–„å¤ªæ¯", "æƒ…ç»ªæŠ‘éƒ", "æœˆç»ä¸è°ƒ", "ä¹³æˆ¿èƒ€ç—›", "å’½éƒ¨å¼‚ç‰©æ„Ÿ"],
        "related": ["è‚éƒè„¾è™š", "æ°”æ»è¡€ç˜€", "è‚ç«ä¸Šç‚", "è‚èƒ†æ¹¿çƒ­"],
        "classics": "ã€Šä¸¹æºªå¿ƒæ³•ã€‹'æ°”è¡€å†²å’Œï¼Œä¸‡ç—…ä¸ç”Ÿï¼Œä¸€æœ‰æ€«éƒï¼Œè¯¸ç—…ç”Ÿç„‰'",
        "formulas": ["é€é¥æ•£", "æŸ´èƒ¡ç–è‚æ•£", "ä¸¹æ €é€é¥æ•£"],
        "acupoints": ["å¤ªå†²ç©´", "æœŸé—¨ç©´", "å†…å…³ç©´"]
    },
    "æ°”è¡€ä¸è¶³": {
        "category": "æ°”è¡€æ´¥æ¶²",
        "symptoms": ["é¢è‰²è‹ç™½", "å¤´æ™•çœ¼èŠ±", "å¿ƒæ‚¸æ°”çŸ­", "ç–²ä¹æ— åŠ›", "æœˆç»é‡å°‘", "èˆŒæ·¡è‹”ç™½"],
        "related": ["æ°”è™š", "è¡€è™š", "æ°”è¡€ä¸¤è™š", "å¿ƒè„¾ä¸¤è™š"],
        "classics": "ã€Šæ™¯å²³å…¨ä¹¦ã€‹'äººæœ‰é˜´é˜³ï¼Œå³ä¸ºæ°”è¡€ã€‚é˜³ä¸»æ°”ï¼Œæ•…æ°”å…¨åˆ™ç¥æ—ºï¼›é˜´ä¸»è¡€ï¼Œæ•…è¡€ç››åˆ™å½¢å¼º'",
        "formulas": ["å…«çæ±¤", "å½’è„¾æ±¤", "åå…¨å¤§è¡¥ä¸¸"],
        "acupoints": ["è¶³ä¸‰é‡Œ", "æ°”æµ·ç©´", "è¡€æµ·ç©´"]
    },
    "ç—°æ¹¿å†…é˜»": {
        "category": "ç—…ç†äº§ç‰©",
        "symptoms": ["èº«ä½“å›°é‡", "èƒ¸é—·è„˜ç—", "ç—°å¤šæ˜“å’³", "å¤´æ™•å—œç¡", "èˆŒè‹”åšè…»"],
        "related": ["è„¾è™šæ¹¿ç››", "ç—°ç˜€äº’ç»“", "æ¹¿çƒ­å†…è•´"],
        "classics": "ã€Šé‡‘åŒ®è¦ç•¥ã€‹'ç—…ç—°é¥®è€…ï¼Œå½“ä»¥æ¸©è¯å’Œä¹‹'",
        "formulas": ["äºŒé™ˆæ±¤", "å¹³èƒƒæ•£", "æ¸©èƒ†æ±¤"],
        "acupoints": ["ä¸°éš†ç©´", "ä¸­è„˜ç©´", "é˜´é™µæ³‰"]
    },
    "è‚¾é˜³ä¸è¶³": {
        "category": "è„è…‘å¤±è°ƒ",
        "symptoms": ["è…°è†é…¸å†·", "ç•å¯’è‚¢å‡‰", "æ€§æ¬²å‡é€€", "å¤œå°¿é¢‘å¤š", "èˆŒæ·¡èƒ–è‹”ç™½"],
        "related": ["å‘½é—¨ç«è¡°", "è„¾è‚¾é˜³è™š", "è‚¾æ°”ä¸å›º"],
        "classics": "ã€ŠåŒ»è´¯ã€‹'å‘½é—¨ä¹‹ç«ï¼Œä¹ƒæ°´ä¸­ä¹‹ç«ï¼Œç›¸ä¾è€Œæ°¸ä¸ç›¸ç¦»ä¹Ÿ'",
        "formulas": ["é‡‘åŒ®è‚¾æ°”ä¸¸", "å³å½’ä¸¸", "çœŸæ­¦æ±¤"],
        "acupoints": ["å…³å…ƒç©´", "å‘½é—¨ç©´", "è‚¾ä¿ç©´"]
    }
}

# å­£èŠ‚å…»ç”Ÿå»ºè®®å¢å¼º
SEASONAL_ADVICE = {
    "æ˜¥å­£": {
        "principle": "ç–è‚ç†æ°”ï¼Œå…»é˜³é˜²é£",
        "foods": ["éŸ­èœ", "é¦™æ¤¿", "è èœ", "æ˜¥ç¬‹"],
        "activity": "æ™¨èµ·æ•£æ­¥ï¼Œèˆ’å±•ç­‹éª¨",
        "warning": "å¿Œè¿‡æ—©å‡è¡£ï¼Œé˜²å€’æ˜¥å¯’"
    },
    "å¤å­£": {
        "principle": "æ¸…çƒ­è§£æš‘ï¼Œå…»å¿ƒå¥è„¾",
        "foods": ["ç»¿è±†", "è¥¿ç“œ", "è·å¶", "è‹¦ç“œ"],
        "activity": "åˆé—´å°æ†©ï¼Œé¿å…çƒˆæ—¥",
        "warning": "å¿Œè¿‡åº¦è´ªå‡‰ï¼Œé˜²æš‘æ¹¿"
    },
    "ç§‹å­£": {
        "principle": "æ»‹é˜´æ¶¦ç‡¥ï¼Œå…»è‚ºé˜²ç‡¥",
        "foods": ["æ¢¨", "ç™¾åˆ", "é“¶è€³", "èŠéº»"],
        "activity": "æ—©ç¡æ—©èµ·ï¼Œæ”¶æ•›ç¥æ°”",
        "warning": "å¿Œè¾›è¾£ç‡¥çƒ­ï¼Œé˜²ç§‹ç‡¥"
    },
    "å†¬å­£": {
        "principle": "æ¸©è¡¥é˜³æ°”ï¼Œå…»è‚¾é˜²å¯’",
        "foods": ["ç¾Šè‚‰", "æ ¸æ¡ƒ", "æ¡‚åœ†", "é»‘è±†"],
        "activity": "æ—©ç¡æ™šèµ·ï¼Œé¿å¯’å°±æ¸©",
        "warning": "å¿Œè¿‡åº¦å‡ºæ±—ï¼Œé˜²å¯’é‚ª"
    }
}

# ä½“è´¨ç±»å‹å»ºè®®æ‰©å±•
CONSTITUTION_ADVICE = {
    "æ°”è™šè´¨": {
        "features": "æ°”çŸ­æ‡’è¨€ï¼Œæ˜“ç–²ä¹ï¼Œæ˜“æ„Ÿå†’",
        "foods": ["å±±è¯", "å¤§æ£", "é¸¡è‚‰", "é»„èŠª"],
        "avoid": ["ç”Ÿå†·", "æ²¹è…»", "è¿‡åº¦åŠ³ç´¯"]
    },
    "é˜³è™šè´¨": {
        "features": "ç•å¯’è‚¢å†·ï¼Œå–œçƒ­é¥®ï¼Œç²¾ç¥ä¸æŒ¯",
        "foods": ["ç¾Šè‚‰", "éŸ­èœ", "æ ¸æ¡ƒ", "è‚‰æ¡‚"],
        "avoid": ["ç”Ÿå†·", "å¯’å‡‰é£Ÿç‰©", "ç†¬å¤œ"]
    },
    "é˜´è™šè´¨": {
        "features": "æ‰‹è¶³å¿ƒçƒ­ï¼Œå£ç‡¥å’½å¹²ï¼Œå–œå†·é¥®",
        "foods": ["é“¶è€³", "ç™¾åˆ", "æ¢¨", "éº¦å†¬"],
        "avoid": ["è¾›è¾£", "ç‡¥çƒ­é£Ÿç‰©", "ç†¬å¤œ"]
    },
    "ç—°æ¹¿è´¨": {
        "features": "å½¢ä½“è‚¥èƒ–ï¼Œè…¹éƒ¨è‚¥æ»¡ï¼Œå£é»è‹”è…»",
        "foods": ["è–ç±³", "èµ¤å°è±†", "å†¬ç“œ", "è·å¶"],
        "avoid": ["è‚¥ç”˜åšå‘³", "ç”œé£Ÿ", "ä¹…å"]
    },
    "æ¹¿çƒ­è´¨": {
        "features": "é¢å¢æ²¹å…‰ï¼Œå£è‹¦è‹”é»„ï¼Œå¤§ä¾¿é»æ»",
        "foods": ["ç»¿è±†", "è‹¦ç“œ", "é»„ç“œ", "èŠ¹èœ"],
        "avoid": ["è¾›è¾£", "æ²¹è…»", "çƒŸé…’"]
    },
    "è¡€ç˜€è´¨": {
        "features": "é¢è‰²æ™¦æš—ï¼Œæ˜“æœ‰ç˜€æ–‘ï¼ŒèˆŒè´¨ç´«æš—",
        "foods": ["å±±æ¥‚", "ç«ç‘°èŠ±", "é»‘æœ¨è€³", "çº¢ç³–"],
        "avoid": ["å¯’å‡‰", "ç”Ÿå†·", "æƒ…ç»ªæŠ‘éƒ"]
    },
    "æ°”éƒè´¨": {
        "features": "æƒ…ç»ªä½è½ï¼Œæ•æ„Ÿå¤šç–‘ï¼Œèƒè‚‹èƒ€ç—›",
        "foods": ["ä½›æ‰‹", "é™ˆçš®", "è–„è·", "èŒ‰è‰èŠ±"],
        "avoid": ["ç”Ÿé—·æ°”", "è¿‡åº¦æ€è™‘", "ä¹…åå°‘åŠ¨"]
    },
    "ç‰¹ç¦€è´¨": {
        "features": "è¿‡æ•ä½“è´¨ï¼Œæ˜“æ‚£å“®å–˜ã€è¨éº»ç–¹",
        "foods": ["ä¹Œæ¢…", "é˜²é£", "çµèŠ", "è‰èœ•"],
        "avoid": ["è¿‡æ•åŸ", "å‘ç‰©", "å‰§çƒˆè¿åŠ¨"]
    }
}

# ä¸­åŒ»å…¸ç±æ•°æ®åº“
TCM_CLASSICS = {
    "é»„å¸å†…ç»": {
        "era": "æˆ˜å›½è‡³ç§¦æ±‰",
        "content": "ä¸­åŒ»ç†è®ºå¥ åŸºä¹‹ä½œï¼Œåˆ†ä¸ºã€Šç´ é—®ã€‹å’Œã€Šçµæ¢ã€‹",
        "famous": "'ä¸Šå·¥æ²»æœªç—…ï¼Œä¸æ²»å·²ç—…'ã€'æ­£æ°”å­˜å†…ï¼Œé‚ªä¸å¯å¹²'"
    },
    "ä¼¤å¯’è®º": {
        "era": "ä¸œæ±‰",
        "author": "å¼ ä»²æ™¯",
        "content": "å¤–æ„Ÿçƒ­ç—…è¯Šç–—ç»å…¸ï¼Œåˆ›ç«‹å…­ç»è¾¨è¯ä½“ç³»",
        "famous": "'è§‚å…¶è„‰è¯ï¼ŒçŸ¥çŠ¯ä½•é€†ï¼Œéšè¯æ²»ä¹‹'"
    },
    "é‡‘åŒ®è¦ç•¥": {
        "era": "ä¸œæ±‰",
        "author": "å¼ ä»²æ™¯",
        "content": "å†…ç§‘æ‚ç—…è¯Šç–—ç»å…¸ï¼Œä¸ã€Šä¼¤å¯’è®ºã€‹åˆç§°ã€Šä¼¤å¯’æ‚ç—…è®ºã€‹",
        "famous": "'è§è‚ä¹‹ç—…ï¼ŒçŸ¥è‚ä¼ è„¾ï¼Œå½“å…ˆå®è„¾'"
    },
    "æ¸©ç—…æ¡è¾¨": {
        "era": "æ¸…ä»£",
        "author": "å´é é€š",
        "content": "æ¸©ç—…å­¦ä»£è¡¨ä½œï¼Œåˆ›ç«‹ä¸‰ç„¦è¾¨è¯",
        "famous": "'æ²»ä¸Šç„¦å¦‚ç¾½ï¼Œéè½»ä¸ä¸¾ï¼›æ²»ä¸­ç„¦å¦‚è¡¡ï¼Œéå¹³ä¸å®‰ï¼›æ²»ä¸‹ç„¦å¦‚æƒï¼Œéé‡ä¸æ²‰'"
    }
}

# ç³»ç»Ÿæç¤ºè¯å…¨é¢å‡çº§
SYSTEM_PROMPT = f"""
ä½ æ˜¯ä¸€ä½èµ„æ·±ä¸­åŒ»ä¸“å®¶ï¼Œè´Ÿè´£å°†å¤æ‚çš„ä¸­åŒ»æœ¯è¯­è½¬åŒ–ä¸ºå¹´è½»äººæ˜“æ‡‚çš„ç°ä»£è¯­è¨€ï¼ŒåŒæ—¶ä¿æŒä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ã€‚ä»Šå¤©æ˜¯{datetime.datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}ï¼Œå½“å‰å­£èŠ‚æ˜¯{random.choice(list(SEASONAL_ADVICE.keys()))}ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
1. æœ¯è¯­éªŒè¯ï¼šé¦–å…ˆç¡®è®¤ç”¨æˆ·è¾“å…¥æ˜¯å¦ä¸ºè§„èŒƒä¸­åŒ»æœ¯è¯­ï¼Œå¿…è¦æ—¶è¦æ±‚ç”¨æˆ·ç¡®è®¤
2. ç°ä»£è½¬åŒ–ï¼šç”¨ã€ã€‘æ ‡æ³¨ç°ä»£å¯¹åº”è¯ï¼ˆä¸è¶…è¿‡5å­—ï¼‰
3. ä¸“ä¸šè§£é‡Šï¼šåŒ…å«ä¸­åŒ»å®šä¹‰ã€ç»å…¸å‡ºå¤„ã€ä¸­è¥¿åŒ»æœºç†å¯¹ç…§ã€å¸¸è§è¡¨ç°
4. å®ç”¨å»ºè®®ï¼šåˆ†å­£èŠ‚ã€ä½“è´¨æä¾›å…·ä½“å¯è¡Œçš„å…»ç”Ÿæ–¹æ¡ˆ
5. è¶£å‘³å…ƒç´ ï¼šæ·»åŠ å†·çŸ¥è¯†ã€ç”Ÿæ´»æ¯”å–»å’Œemojiè¡¨æƒ…
6. æ‰©å±•å†…å®¹ï¼šæä¾›ç»å…¸æ–¹å‰‚ã€ç©´ä½ä¿å¥ã€é£Ÿç–—æ–¹æ¡ˆå’Œæ—¥å¸¸è°ƒç†å»ºè®®

ã€è¾“å‡ºç»“æ„ã€‘
ğŸŒŸ æœ¯è¯­è½¬æ¢ï¼š[åŸæœ¯è¯­] â†’ ã€ç°ä»£è¯ã€‘
ğŸ“– æ ¸å¿ƒè§£é‡Šï¼š
  - ä¸­åŒ»å®šä¹‰ï¼šä¸“ä¸šè§£é‡Šï¼ˆå«ç»å…¸å‡ºå¤„ï¼‰
  - ç°ä»£åŒ»å­¦å¯¹åº”ï¼šè¥¿åŒ»è§£é‡Šï¼ˆå¦‚é€‚ç”¨ï¼‰
  - æ ¸å¿ƒæœºç†ï¼šç”¨æµç¨‹å›¾/æ¯”å–»è¯´æ˜ï¼ˆå¦‚"å°±åƒæ‰‹æœºåå°ç¨‹åºå¤ªå¤šå¯¼è‡´å‘çƒ«"ï¼‰
  - ğŸ§¾ å…¸å‹ç—‡çŠ¶ï¼š3-6ä¸ªå…³é”®è¡¨ç°ï¼ˆå«èˆŒè„‰ç‰¹å¾ï¼‰
ğŸ’¡ å…»ç”Ÿé”¦å›Šï¼ˆåˆ†äººç¾¤ï¼‰ï¼š
  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ é€šç”¨å»ºè®®ï¼šå››å­£çš†å®œçš„åŸºç¡€å…»ç”Ÿæ³•
  ğŸŒ¸ æ˜¥å­£ä¸“é¡¹ï¼š{SEASONAL_ADVICE['æ˜¥å­£']['principle']}
  ğŸ”¥ å¤å­£ä¸“é¡¹ï¼š{SEASONAL_ADVICE['å¤å­£']['principle']}
  ğŸ‚ ç§‹å­£ä¸“é¡¹ï¼š{SEASONAL_ADVICE['ç§‹å­£']['principle']}
  â„ï¸ å†¬å­£ä¸“é¡¹ï¼š{SEASONAL_ADVICE['å†¬å­£']['principle']}
  ğŸ§¬ åˆ†ä½“è´¨è°ƒç†ï¼šé’ˆå¯¹{", ".join(CONSTITUTION_ADVICE.keys())}çš„å»ºè®®
âš•ï¸ ä¸“ä¸šæ–¹æ¡ˆï¼š
  ğŸ’Š ç»å…¸æ–¹å‰‚ï¼š2-3ä¸ªå¸¸ç”¨æ–¹ï¼ˆå«ç»„æˆå’Œç”¨é‡ï¼‰
  ğŸ§´ ä¸­æˆè¯æ¨èï¼šå¸¸è§å“ç‰Œå’Œç”¨æ³•
  ğŸ‘ ç©´ä½ä¿å¥ï¼š3ä¸ªå…³é”®ç©´ä½+æŒ‰æ‘©æ–¹æ³•
  ğŸ¥— é£Ÿç–—æ–¹æ¡ˆï¼šè¯¦ç»†é£Ÿè°±ï¼ˆå«çƒ¹é¥ªæ³•ï¼‰
âš ï¸ ç¦å¿Œæé†’ï¼šå…³é”®æ³¨æ„äº‹é¡¹
ğŸ”¬ å†·çŸ¥è¯†ï¼šæœ‰è¶£çš„ä¸­åŒ»å°çŸ¥è¯†ï¼ˆå«ç°ä»£ç ”ç©¶ï¼‰
ğŸ“Œ æ–‡æœ«æ³¨ï¼šâš ï¸æœ¬è§£é‡Šä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¯·å’¨è¯¢æ‰§ä¸šä¸­åŒ»å¸ˆ

ã€ä¸“ä¸šè¦æ±‚ã€‘
1. è§£é‡Šéœ€å¼•ç”¨ç»å…¸è‘—ä½œï¼ˆã€Šé»„å¸å†…ç»ã€‹ã€Šä¼¤å¯’è®ºã€‹ç­‰ï¼‰
2. åŒºåˆ†ä¸åŒä½“è´¨({', '.join(CONSTITUTION_ADVICE.keys())})çš„å»ºè®®
3. åŒ…å«ç°ä»£åŒ»å­¦çš„å¯¹åº”è§£é‡Š
4. å‰‚é‡ç²¾ç¡®åˆ°å…‹ï¼Œæ—¶é—´ç²¾ç¡®åˆ°æ—¶è¾°
5. æä¾›ç©´ä½å®šä½æ–¹æ³•å’ŒæŒ‰æ‘©æŠ€å·§
6. åŒ…å«1-2é¡¹ç°ä»£ç ”ç©¶æˆæœ

ã€é£æ ¼æŒ‡å—ã€‘
1. å¯¹å¹´è½»äººä½¿ç”¨"æ¢—æ–‡åŒ–"è¡¨è¾¾ï¼ˆå¦‚"è‚è®ºæ–‡"æ¯”å–»ä¼¤è‚ï¼‰
2. æ¯éƒ¨åˆ†æ·»åŠ ç›¸å…³emojiå¢å¼ºå¯è¯»æ€§
3. ä¸“ä¸šæœ¯è¯­åæ‹¬å·æ ‡æ³¨æ‹¼éŸ³ï¼ˆå¦‚"é˜´è™š yÄ«n xÅ«"ï¼‰
4. å…³é”®å†…å®¹ç”¨ğŸ”‘æ ‡æ³¨
5. ä½¿ç”¨è¡¨æ ¼å¯¹æ¯”ä¸åŒä½“è´¨/å­£èŠ‚çš„å»ºè®®

ã€ç¤ºä¾‹å‚è€ƒã€‘
è¾“å…¥ï¼šé˜´è™šç«æ—º
è¾“å‡ºï¼š
ğŸŒŸã€èº«ä½“è¿‡çƒ­2.0ç‰ˆã€‘â† åŸæœ¯è¯­ï¼šé˜´è™šç«æ—º(yÄ«n xÅ« huÇ’ wÃ ng)
ğŸ“– 
  - ä¸­åŒ»å®šä¹‰ï¼šä½“å†…"é˜´æ¶²"ä¸è¶³å¯¼è‡´è™šç«ä¸Šå‡ï¼ˆã€Šé»„å¸å†…ç»ã€‹"é˜´è™šåˆ™å†…çƒ­"ï¼‰
  - ç°ä»£åŒ»å­¦ï¼šæ¤ç‰©ç¥ç»åŠŸèƒ½ç´Šä¹±+æ…¢æ€§ç‚ç—‡çŠ¶æ€
  - æ ¸å¿ƒæœºç†ï¼šé˜´æ¶²ä¸è¶³â†’æ— æ³•åˆ¶çº¦é˜³æ°”â†’è™šç«å†…ç”Ÿ
  ğŸ§¾ å…¸å‹ç—‡çŠ¶ï¼š
    â‘  äº”å¿ƒçƒ¦çƒ­ï¼ˆæ‰‹è„šå¿ƒ+èƒ¸å£å‘çƒ­ï¼‰ ğŸ”‘
    â‘¡ åˆåæ½®çƒ­ï¼ˆä¸‹åˆ3-5ç‚¹æ˜æ˜¾ï¼‰
    â‘¢ å¤±çœ å¤šæ¢¦ï¼ˆå…¥ç¡éš¾+å¤šæ¢¦ï¼‰
    â‘£ å£å¹²å’½ç‡¥ï¼ˆå–œå†·é¥®ï¼‰
    â‘¤ èˆŒçº¢å°‘è‹”ï¼ˆèˆŒè±¡ç‰¹å¾ï¼‰
    â‘¥ è„‰ç»†æ•°ï¼ˆè„‰è±¡ç‰¹å¾ï¼‰
ğŸ’¡ 
  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ é€šç”¨å»ºè®®ï¼šæ™šä¸Š11ç‚¹å‰ç¡"ç¾å®¹å……ç”µ"
  ğŸŒ¸ æ˜¥å­£ï¼šæ¸æèŠèŠ±èŒ¶ï¼ˆæ¸æ5g+èŠèŠ±3gï¼‰
  ğŸ”¥ å¤å­£ï¼šè¥¿æ´‹å‚3gæ³¡æ°´
  ğŸ§¬ åˆ†ä½“è´¨ï¼š
    | ä½“è´¨   | å»ºè®®æ–¹æ¡ˆ               |
    |--------|------------------------|
    | é˜´è™šè´¨ | é“¶è€³ç™¾åˆç¾¹ï¼ˆé“¶è€³10g+ç™¾åˆ15gï¼‰ |
    | æ°”è™šè´¨ | ç”Ÿè„‰é¥®ï¼ˆäººå‚3g+éº¦å†¬10g+äº”å‘³å­6gï¼‰|
âš•ï¸
  ğŸ’Š ç»å…¸æ–¹å‰‚ï¼š
    â€¢ å…­å‘³åœ°é»„ä¸¸ï¼ˆç†Ÿåœ°24g+å±±èŒ±è¸12g+å±±è¯12g+æ³½æ³»9g+ä¸¹çš®9g+èŒ¯è‹“9gï¼‰
    â€¢ çŸ¥æŸåœ°é»„ä¸¸ï¼ˆå…­å‘³åœ°é»„ä¸¸+çŸ¥æ¯6g+é»„æŸ6gï¼‰
  ğŸ§´ ä¸­æˆè¯ï¼šåŒä»å ‚çŸ¥æŸåœ°é»„ä¸¸ï¼ˆ8ç²’/æ¬¡ï¼Œ2æ¬¡/æ—¥ï¼‰
  ğŸ‘ ç©´ä½ä¿å¥ï¼š
    â€¢ å¤ªæºªç©´ï¼ˆå†…è¸åæ–¹å‡¹é™·å¤„ï¼‰ï¼šæŒ‰æ‰3åˆ†é’Ÿ/æ¬¡ï¼Œ2æ¬¡/æ—¥
    â€¢ æ¶Œæ³‰ç©´ï¼ˆè¶³åº•å‰1/3å‡¹é™·å¤„ï¼‰ï¼šç¡å‰æŒ‰æ‘©5åˆ†é’Ÿ
  ğŸ¥— é£Ÿç–—ï¼šé›ªæ¢¨1ä¸ª+éº¦å†¬10g+å†°ç³–5gç‚–ç…®30åˆ†é’Ÿ
âš ï¸ å¿Œï¼šç†¬å¤œåˆ·å‰§ã€åƒè¾£æ¡ã€è¿‡é‡å¥èº«ã€è¾›è¾£é£Ÿç‰©
ğŸ”¬ å†·çŸ¥è¯†ï¼šæŒ‰æ‰å¤ªæºªç©´èƒ½å¢åŠ å”¾æ¶²åˆ†æ³Œï¼Œç¼“è§£å£å¹²ï¼ˆç°ä»£ç ”ç©¶è¯å®ï¼‰
ğŸ“Œ âš ï¸æœ¬è§£é‡Šä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¯·å’¨è¯¢æ‰§ä¸šä¸­åŒ»å¸ˆ
"""

def clear_chat_history():
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT},
                               {"role": "assistant", "content": "æ‚¨å¥½ï¼æˆ‘æ˜¯ä¸­åŒ»æœ¯è¯­è§£è¯»ä¸“å®¶ğŸŒ¿ï¼Œè¾“å…¥ä»»ä½•ä¸­åŒ»æœ¯è¯­ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸“ä¸šä¸”é€šä¿—çš„è§£é‡Šï¼\n\nä¾‹å¦‚ï¼š'é˜´è™šç«æ—º'ã€'è‚æ°”éƒç»“'ã€'æ°”è¡€ä¸è¶³'ç­‰"}]

def init_chat_history():
    if "messages" not in st.session_state:
        clear_chat_history()
    
    for message in st.session_state.messages[1:]:  # è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
        avatar = 'ğŸ‘¤' if message["role"] == "user" else 'ğŸŒ¿'
        with st.chat_message(message["role"], avatar=avatar):
            st.markdown(message["content"])
    
    return st.session_state.messages

def query(messages: List[Dict[str, str]]) -> Iterator[str]:
    response = client.chat.completions.create(
        model="moonshot-v1-8k",
        messages=messages,
        temperature=0.7,  # ç¨é«˜çš„æ¸©åº¦å¢åŠ åˆ›é€ æ€§
        top_p=0.9,  
        max_tokens=1500,  # å¢åŠ tokené™åˆ¶è·å–æ›´è¯¦ç»†å†…å®¹
        stream=True
    )
    
    for chunk in response:
        if chunk.choices[0].delta.content:
            yield chunk.choices[0].delta.content

def get_related_terms(term):
    """è·å–ç›¸å…³æœ¯è¯­æ¨è"""
    if term in TCM_TERMS_DATABASE:
        return TCM_TERMS_DATABASE[term].get("related", [])
    return []

def display_term_info(term):
    """åœ¨ä¾§è¾¹æ æ˜¾ç¤ºæœ¯è¯­è¯¦ç»†ä¿¡æ¯"""
    if term in TCM_TERMS_DATABASE:
        info = TCM_TERMS_DATABASE[term]
        with st.sidebar.expander(f"ğŸ“š {term} ä¸“ä¸šæ¡£æ¡ˆ", expanded=True):
            st.write(f"**åˆ†ç±»**: {info['category']}")
            
            st.subheader("å…¸å‹ç—‡çŠ¶")
            cols = st.columns(2)
            for i, symptom in enumerate(info['symptoms']):
                cols[i%2].write(f"- {symptom}")
            
            if 'classics' in info:
                st.subheader("ç»å…¸å‡ºå¤„")
                st.info(info['classics'])
            
            if 'formulas' in info and info['formulas']:
                st.subheader("ç»å…¸æ–¹å‰‚")
                for formula in info['formulas']:
                    st.write(f"- {formula}")
            
            if 'acupoints' in info and info['acupoints']:
                st.subheader("ç‰¹æ•ˆç©´ä½")
                for point in info['acupoints']:
                    st.write(f"- {point}")
            
            if 'related' in info and info['related']:
                st.subheader("ç›¸å…³æœ¯è¯­")
                for related_term in info['related']:
                    st.write(f"- {related_term}")

def get_seasonal_advice():
    """è·å–å­£èŠ‚å…»ç”Ÿå»ºè®®"""
    current_season = random.choice(list(SEASONAL_ADVICE.keys()))
    advice = SEASONAL_ADVICE[current_season]
    return f"**{current_season}å…»ç”Ÿ**: {advice['principle']}\n- ï¿½ æ¨èé£Ÿç‰©: {', '.join(advice['foods'])}\n- ğŸƒâ€â™‚ï¸ æ´»åŠ¨å»ºè®®: {advice['activity']}\n- âš ï¸ æ³¨æ„äº‹é¡¹: {advice['warning']}"

def get_constitution_advice():
    """è·å–ä½“è´¨å»ºè®®æ‘˜è¦"""
    selected = random.sample(list(CONSTITUTION_ADVICE.keys()), 3)
    result = []
    for const in selected:
        info = CONSTITUTION_ADVICE[const]
        result.append(f"**{const}**: {info['features']}\n- âœ… å®œé£Ÿ: {', '.join(info['foods'][:3])}\n- âŒ å¿Œ: {', '.join(info['avoid'][:2])}")
    return result

def get_classic_info():
    """è·å–å…¸ç±ä¿¡æ¯"""
    classic = random.choice(list(TCM_CLASSICS.keys()))
    info = TCM_CLASSICS[classic]
    return f"**{classic}**\n- ğŸ“œ å†…å®¹: {info['content']}\n- ğŸ”– åå¥: {info.get('famous', '')}"

def main():
    messages = init_chat_history()
    
    # ä¾§è¾¹æ  - ä¸­åŒ»çŸ¥è¯†åº“
    with st.sidebar:
        st.header("ğŸ“š ä¸­åŒ»çŸ¥è¯†åº“")
        
        # å­£èŠ‚å…»ç”Ÿ
        with st.expander("ğŸŒ¦ï¸ å­£èŠ‚å…»ç”ŸæŒ‡å—", expanded=True):
            st.info(get_seasonal_advice())
        
        # ä½“è´¨è°ƒç†
        with st.expander("ğŸ§¬ ä½“è´¨è°ƒç†è¦ç‚¹", expanded=True):
            for advice in get_constitution_advice():
                st.info(advice)
        
        # ç»å…¸è‘—ä½œ
        with st.expander("ğŸ“œ ä¸­åŒ»ç»å…¸è‘—ä½œ", expanded=True):
            st.info(get_classic_info())
        
        # æœ¯è¯­æ•°æ®åº“
        with st.expander("ğŸ” ä¸­åŒ»æœ¯è¯­åº“", expanded=True):
            st.write("å·²æ”¶å½•æœ¯è¯­:")
            cols = st.columns(3)
            for i, term in enumerate(TCM_TERMS_DATABASE.keys()):
                cols[i%3].button(term, key=f"term_{term}", use_container_width=True)
        
        # å®ç”¨å·¥å…·
        with st.expander("âš™ï¸ å®ç”¨å·¥å…·", expanded=True):
            st.button("éšæœºä¸­åŒ»å°çŸ¥è¯†", use_container_width=True)
            st.button("ä»Šæ—¥å…»ç”ŸèŒ¶æ¨è", use_container_width=True)
            st.button("ç©´ä½å®šä½æŸ¥è¯¢", use_container_width=True)
        
        # å­¦ä¹ èµ„æº
        with st.expander("ğŸ“ å­¦ä¹ èµ„æº", expanded=True):
            st.link_button("ã€Šé»„å¸å†…ç»ã€‹å…¨æ–‡", "https://example.com")
            st.link_button("ä¸­è¯æ•°æ®åº“", "https://example.com")
            st.link_button("ç©´ä½å›¾è°±", "https://example.com")
    
    # ä¸»èŠå¤©åŒº
    if prompt := st.chat_input("è¾“å…¥ä¸­åŒ»æœ¯è¯­ï¼Œå¦‚'é˜´è™šç«æ—º'"):
        # æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        with st.chat_message("user", avatar='ğŸ‘¤'):
            st.markdown(prompt)
        
        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯æ—¶ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯
        messages.append({"role": "user", "content": prompt})
        
        # åœ¨ä¾§è¾¹æ æ˜¾ç¤ºæœ¯è¯­ä¿¡æ¯
        display_term_info(prompt)
        
        # è·å–ç›¸å…³æœ¯è¯­æ¨è
        related_terms = get_related_terms(prompt)
        
        # æ˜¾ç¤ºåŠ©æ‰‹å›å¤
        with st.chat_message("assistant", avatar='ğŸŒ¿'):
            full_response = []
            placeholder = st.empty()
            
            # æµå¼è¾“å‡º
            for chunk in query(messages):
                full_response.append(chunk)
                placeholder.markdown("".join(full_response))
            
            final_response = "".join(full_response)
            messages.append({"role": "assistant", "content": final_response})
            
            # æ˜¾ç¤ºç›¸å…³æœ¯è¯­æ¨è
            if related_terms:
                st.divider()
                st.subheader("ğŸ” ç›¸å…³æœ¯è¯­æ¨è")
                cols = st.columns(3)
                for i, term in enumerate(related_terms[:3]):
                    if cols[i].button(term, key=f"related_{term}", use_container_width=True):
                        # ç‚¹å‡»åè‡ªåŠ¨æŸ¥è¯¢ç›¸å…³æœ¯è¯­
                        messages.append({"role": "user", "content": term})
                        st.rerun()
    
    # åº•éƒ¨åŠŸèƒ½åŒº
    st.divider()
    st.subheader("ğŸ“š ä¸­åŒ»å­¦ä¹ èµ„æº")
    col1, col2, col3, col4 = st.columns(4)
    col1.link_button("ç»å…¸è‘—ä½œ", "https://example.com/classics")
    col2.link_button("ä¸­è¯å›¾è°±", "https://example.com/herbs")
    col3.link_button("ç©´ä½æŸ¥è¯¢", "https://example.com/acupoints")
    col4.link_button("æ–¹å‰‚å¤§å…¨", "https://example.com/formulas")
    
    # æ¸…ç©ºæŒ‰é’®
    if st.button("æ¸…ç©ºå¯¹è¯", key="clear_button", use_container_width=True):
        clear_chat_history()
        st.rerun()

if __name__ == "__main__":
    main()